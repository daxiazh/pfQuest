# pfQuest 任务数据合并机制说明

## 概述

pfQuest 插件通过 `patchtable.lua` 实现了基础任务数据与乌龟服自定义数据的自动合并机制，确保插件能同时支持经典版本内容和乌龟服特有内容。

## 数据文件结构

### 基础数据文件
- `pfQuest/db/quests.lua` - 存储经典版本(1.12)的任务数据
  ```lua
  pfDB["quests"]["data"] = {
    [1] = {
      ["lvl"] = 4,
      ["min"] = 1,
      ["race"] = 255,
      ["start"] = { ["I"] = { 6497 } },
    },
    -- 更多任务数据...
  }
  ```

### 乌龟服扩展数据文件
- `pfQuest-turtle/db/quests-turtle.lua` - 存储乌龟服自定义任务数据
  ```lua
  pfDB["quests"]["data-turtle"] = {
    [1] = "_",           -- "_" 表示删除基础数据中的任务1
    [2] = {              -- 覆盖/修改任务2的数据
      ["end"] = { ["U"] = { 12696 } },
      ["lvl"] = 30,
      ["min"] = 20,
      ["pre"] = { 6383 },
      ["race"] = 434,
    },
    [40001] = {          -- 新增乌龟服专属任务
      ["lvl"] = 60,
      ["start"] = { ["U"] = { 80001 } },
    },
    -- 更多乌龟服数据...
  }
  ```

## 核心合并函数

### patchtable 函数
位置：`pfQuest-turtle/patchtable.lua:7-15`

```lua
local function patchtable(base, diff)
  for k, v in pairs(diff) do
    if type(v) == "string" and v == "_" then
      base[k] = nil          -- 删除操作
    else
      base[k] = v           -- 覆盖/新增操作
    end
  end
end
```

**功能说明：**
- **覆盖合并**：将 `diff` 表中的数据覆盖到 `base` 表对应位置
- **删除操作**：当值为字符串 `"_"` 时，删除 base 表中对应的项
- **新增数据**：自动添加 base 表中不存在的新项

## 合并执行流程

### 1. 数据库列表定义
```lua
local dbs = { "items", "quests", "quests-itemreq", "objects", "units", "zones", "professions", "areatrigger", "refloot" }
```

### 2. 主数据合并循环
位置：`pfQuest-turtle/patchtable.lua:26-37`

```lua
for _, db in pairs(dbs) do
  -- 合并主数据表
  if pfDB[db]["data-turtle"] then
    patchtable(pfDB[db]["data"], pfDB[db]["data-turtle"])
  end

  -- 合并多语言数据表
  for loc, _ in pairs(pfDB.locales) do
    if pfDB[db][loc] and pfDB[db][loc.."-turtle"] then
      loc_update = pfDB[db][loc.."-turtle"] or pfDB[db]["enUS-turtle"]
      patchtable(pfDB[db][loc], loc_update)
    end
  end
end
```

### 3. 专业技能特殊处理
```lua
loc_core = pfDB["professions"][loc] or pfDB["professions"]["enUS"]
loc_update = pfDB["professions"][loc.."-turtle"] or pfDB["professions"]["enUS-turtle"]
if loc_update then patchtable(loc_core, loc_update) end
```

## 合并结果示例

### 任务合并前后对比

**基础数据（quests.lua）：**
```lua
[2] = {
  ["lvl"] = 5,
  ["min"] = 1,
  ["race"] = 255,
  ["start"] = { ["U"] = { 823 } },
}
```

**乌龟服数据（quests-turtle.lua）：**
```lua
[2] = {
  ["end"] = { ["U"] = { 12696 } },
  ["lvl"] = 30,
  ["min"] = 20,
  ["pre"] = { 6383 },
  ["race"] = 434,
}
```

**合并后最终数据：**
```lua
[2] = {
  ["end"] = { ["U"] = { 12696 } },    -- 来自乌龟服
  ["lvl"] = 30,                       -- 覆盖基础数据
  ["min"] = 20,                       -- 覆盖基础数据
  ["pre"] = { 6383 },                 -- 新增字段
  ["race"] = 434,                     -- 覆盖基础数据
  -- ["start"] 字段被完全覆盖，原值丢失
}
```

## 特殊操作

### 1. 删除操作
```lua
[1] = "_",  -- 删除任务ID为1的任务
```

### 2. 自定义种族支持
```lua
if pfDB.bitraces then
  pfDB.bitraces[256] = "Goblin"     -- 哥布林
  pfDB.bitraces[512] = "BloodElf"   -- 血精灵
end
```

### 3. 数据库URL更新
```lua
pfQuest.dburl = "https://database.turtle-wow.org/?quest="
```

## 多语言支持

合并机制同时处理多语言数据：
- `zhCN` + `zhCN-turtle` → 中文数据合并
- `enUS` + `enUS-turtle` → 英文数据合并
- 如果当前语言的乌龟服数据不存在，回退到英文乌龟服数据

## 缓存与更新检测

### 自动缓存清理机制
位置：`pfQuest-turtle/patchtable.lua:157-179`

```lua
local updatecheck = CreateFrame("Frame")
updatecheck:SetScript("OnEvent", function()
  if pfDB["quests"]["data-turtle"] then
    local count = 0
    for k, v in pairs(pfDB["quests"]["data-turtle"]) do
      count = count + 1
    end
    
    -- 检测任务数量变化，自动清理缓存
    if not pfQuest_turtlecount or pfQuest_turtlecount ~= count then
      pfQuest_questcache = {}  -- 清空缓存强制重新初始化
    end
    
    pfQuest_turtlecount = count
  end
end)
```

## 执行时机

1. **插件加载时**：`patchtable.lua` 在所有数据文件加载完成后执行
2. **进入游戏世界时**：检测新任务并清理缓存
3. **数据库重载时**：调用 `pfDatabase:Reload()` 刷新内部快捷方式

## 注意事项

1. **数据覆盖**：乌龟服数据会完全覆盖基础数据中的同名字段
2. **删除不可逆**：使用 `"_"` 删除的数据无法恢复
3. **执行顺序**：必须在所有基础数据文件加载完成后执行合并
4. **缓存管理**：新增任务时会自动清理缓存，确保数据一致性

## 文件依赖关系

```
pfQuest/db/quests.lua (基础数据)
         ↓
pfQuest-turtle/db/quests-turtle.lua (乌龟服数据)
         ↓
pfQuest-turtle/patchtable.lua (合并逻辑)
         ↓
最终合并的 pfDB["quests"]["data"] (运行时数据)
```